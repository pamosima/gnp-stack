# gNMIc emitter including IOS-XE stream (srl, eos, iosxe) â†’ Prometheus
# Use this as your single emitter when running Cisco C9k alongside SRL/EOS,
# or merge the iosxe input and processor into gnmic-emitter.yaml.
---
log: true

inputs:
  nats-srl:
    type: jetstream
    name: gnmic-srl-emitter
    address: nats:4222
    stream: srl
    subjects: []
    format: event
    deliver-policy: new
    subject-format: subscription.target
    connect-time-wait: 3s
    debug: false
    num-workers: 1
    buffer-size: 1000
    fetch-batch-size: 500
    outputs:
      - prom-write
    event-processors:
      - srl-up-down-map

  nats-eos:
    type: jetstream
    name: gnmic-eos-emitter
    address: nats:4222
    stream: eos
    subjects: []
    format: event
    deliver-policy: new
    subject-format: subscription.target
    connect-time-wait: 3s
    debug: false
    num-workers: 1
    buffer-size: 1000
    fetch-batch-size: 500
    outputs:
      - prom-write
    event-processors:
      - eos-up-down-map

  nats-iosxe:
    type: jetstream
    name: gnmic-iosxe-emitter
    address: nats:4222
    stream: iosxe
    subjects: []
    format: event
    deliver-policy: new
    subject-format: subscription.target
    connect-time-wait: 3s
    debug: false
    num-workers: 1
    buffer-size: 1000
    fetch-batch-size: 500
    outputs:
      - prom-write
    event-processors:
      - iosxe-up-down-map

outputs:
  prom-write:
    type: prometheus_write
    url: http://prometheus:9090/api/v1/write
    interval: 10s
    buffer-size: 1000
    max-time-series-per-write: 500
    strings-as-labels: true
    timeout: 10s
    enable-metrics: true
    event-processors: []
    num-workers: 1
    num-writers: 1
    debug: false

processors:
  srl-up-down-map:
    event-strings:
      value-names:
        - "oper-state"
      transforms:
        - replace:
            apply-on: "value"
            old: "up"
            new: "1"
        - replace:
            apply-on: "value"
            old: "down"
            new: "0"

  eos-up-down-map:
    event-strings:
      value-names:
        - oper-status
        - admin-status
      transforms:
        - replace:
            apply-on: "value"
            old: "up"
            new: "1"
        - replace:
            apply-on: "value"
            old: "UP"
            new: "1"
        - replace:
            apply-on: "value"
            old: "down"
            new: "0"
        - replace:
            apply-on: "value"
            old: "DOWN"
            new: "0"

  iosxe-up-down-map:
    event-strings:
      value-names:
        - oper-status
        - admin-status
      transforms:
        - replace:
            apply-on: "value"
            old: "up"
            new: "1"
        - replace:
            apply-on: "value"
            old: "UP"
            new: "1"
        - replace:
            apply-on: "value"
            old: "down"
            new: "0"
        - replace:
            apply-on: "value"
            old: "DOWN"
            new: "0"

api-server:
  address: :7890
  timeout: 10s
  enable-metrics: true
  debug: false
  healthz-disable-logging: true
